# PDF内容提取功能开发经验总结

**日期**: 2026-01-01
**项目**: MyWind 智能投资终端
**功能**: 披露易公告PDF内容提取

---

## 需求背景

用户要求提取披露易(HKEXnews)公告PDF的具体内容，而不仅仅是标题和链接。

---

## 技术方案评估

| 方案 | 优点 | 缺点 | 结论 |
|------|------|------|------|
| Tesseract.js OCR | 项目已有，适合图片 | PDF需先转图片，复杂 | ❌ 不推荐 |
| pdf-parse 2.x | 新版本 | API复杂，兼容性差 | ❌ 不推荐 |
| **pdf-parse 1.1.1** | API简单稳定 | 旧版本 | ✅ 推荐 |

---

## 遇到的问题及解决方案

### 问题1：HTTP 503错误

**现象**: 直接用axios/fetch请求PDF返回503

**原因**: 披露易有反爬机制，拒绝非浏览器请求

**解决方案**: 使用Puppeteer + CDP协议拦截PDF响应

```javascript
const client = await page.target().createCDPSession();
await client.send('Fetch.enable', {
    patterns: [{ urlPattern: '*', requestStage: 'Response' }]
});

client.on('Fetch.requestPaused', async ({ requestId, request }) => {
    if (request.url.includes('.pdf')) {
        const { body, base64Encoded } = await client.send('Fetch.getResponseBody', { requestId });
        pdfBuffer = Buffer.from(body, base64Encoded ? 'base64' : 'utf8');
    }
    await client.send('Fetch.continueRequest', { requestId });
});
```

### 问题2：pdf-parse版本问题

**现象**: `pdf is not a function` 或 `parser.parse is not a function`

**原因**: pdf-parse 2.x 的API和 1.x 完全不同

| 版本 | 用法 |
|------|------|
| 1.x | `const data = await pdf(buffer)` |
| 2.x | `const parser = new PDFParse(uint8Array); await parser.load(); parser.getText()` |

**解决方案**: 降级到1.1.1

```bash
npm install pdf-parse@1.1.1 --save
```

### 问题3：Puppeteer response.buffer() 失败

**现象**: 用Puppeteer拦截PDF响应时`response.buffer()`返回空或错误

**原因**: Puppeteer原生的响应处理对二进制文件不太可靠

**解决方案**: 使用CDP的`Fetch.getResponseBody`更可靠

---

## 最终实现

### 新增文件
- `utils/pdfExtractor.js` - PDF下载和文本提取工具

### 核心函数
```javascript
// 下载PDF (使用CDP)
async function downloadPdf(url) {
    const page = await puppeteer.createPage(...);
    const client = await page.target().createCDPSession();
    // CDP Fetch拦截...
}

// 解析PDF (pdf-parse 1.x)
async function extractPdfText(pdfBuffer) {
    const pdf = require('pdf-parse');
    const data = await pdf(pdfBuffer);
    return { text: data.text, pages: data.numpages };
}
```

### 采集器集成
```javascript
// 使用方式
await scrapeHKEXNewsForStock('01810.HK', '小米', { 
    maxItems: 2,
    extractContent: true  // 启用PDF内容提取
});
```

---

## 测试结果

| 测试项 | 结果 |
|--------|------|
| PDF下载 | ✅ 成功 (142KB) |
| PDF解析 | ✅ 成功 (8页 ~450字符) |
| 采集器集成 | ✅ 成功 |
| 全量测试 | ✅ 2条公告均成功提取 |

---

## 经验教训

1. **npm包版本很重要**: pdf-parse 2.x 和 1.x API完全不同，升级前要查文档
2. **CDP比Puppeteer原生更强大**: 二进制响应用CDP的Fetch.getResponseBody更可靠
3. **表格PDF文本稀少**: 股份购回报表(FF305)等表格类PDF提取的文本内容有限
4. **性能考虑**: PDF下载+解析耗时约15秒/个，默认关闭提取功能

---

## 相关文件

- `utils/pdfExtractor.js` - PDF提取工具
- `services/stockNewsCollector.js` - 采集器(scrapeHKEXNewsForStock函数)
- `TODO.md` - 项目进度记录

---

*文档生成时间: 2026-01-01 11:50*
