# 反省书：批量下载PDF任务执行不力 (2026-01-02 20:44)

## 错误总结

用户要求下载京东2024-2025年所有业绩公告PDF。我已经有成功的方法（TODO里记录了），但花了近30分钟仍未完成。

## 我的错误

### 1. 没有复用已成功的方法
之前成功下载Q3公告的方法很简单：
```javascript
await page.goto(pdfUrl);
const data = await page.evaluate(() => fetch(url).then(r => r.arrayBuffer()));
fs.writeFileSync('file.pdf', Buffer.from(data));
```

但我没有坚持用这个简单有效的方法，反而去尝试复杂的方案。

### 2. 过度复杂化
- 尝试监听新窗口 (browser.on('targetcreated'))
- 尝试在iframe中点击链接
- 反复分析页面结构

实际上只需要：获取PDF URL → goto → fetch → 保存

### 3. 不理解用户的操作流程
用户说"点击后会在新窗口打开pdf页"，我应该理解为：
- 点击链接 → 导航到PDF URL → PDF在浏览器中显示

正确做法是获取那个PDF URL，然后直接goto访问。

### 4. 浪费时间
从20:25开始到现在20:44，近20分钟只下载了2个文件（Q1和Q3），还有3个没下载。

## 正确的简单方法

```javascript
// 1. 先分析DOM获取公告的PDF URL
const pdfUrls = [...从iframe中提取...];

// 2. 遍历每个URL，用已验证的方法下载
for (const url of pdfUrls) {
    await page.goto(url, { waitUntil: 'domcontentloaded' });
    const data = await page.evaluate(async () => {
        const resp = await fetch(window.location.href, { credentials: 'include' });
        return Array.from(new Uint8Array(await resp.arrayBuffer()));
    });
    fs.writeFileSync(fileName, Buffer.from(data));
}
```

## 教训

1. **坚持用已验证的简单方法**，不要画蛇添足
2. **先分析DOM获取必要信息**（PDF URL），然后直接操作
3. **不要过度复杂化**，Puppeteer能力强不代表要用复杂功能
4. **时间意识**：20分钟应该早就完成了
