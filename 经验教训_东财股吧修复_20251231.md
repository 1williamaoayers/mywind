# 东财股吧(Guba)采集器修复全流程分析

**日期**: 2025-12-31  
**耗时**: 约2小时  
**结果**: ✅ 修复成功，4只股票全部成功，共20条帖子

---

## 1. 问题描述

东财股吧采集器无法正常工作，表现为：
- Puppeteer访问超时
- 或者采集到错误内容（首页热门股票而非搜索结果）

---

## 2. 修复过程时间线

### 阶段1: 初始诊断 (错误方向)

| 时间 | 操作 | 结果 |
|------|------|------|
| 开始 | 怀疑代理问题，创建 `test-guba-noproxy.js` | ❌ 不用代理也超时 |
| +5分 | 用 curl 测试网络 | ✅ HTTP 200，网络可达 |

**教训**: 先用curl确认网络可达性，排除基础设施问题

### 阶段2: 发现 networkidle0 问题

| 时间 | 操作 | 结果 |
|------|------|------|
| +10分 | 改用 `domcontentloaded` | ✅ 首页加载成功！ |
| +12分 | 分析DOM找到搜索框 | `input.noieclear` |
| +15分 | 实现拟人搜索（输入+回车） | ⚠️ 采集到5条，但内容不对 |

**关键发现**: `networkidle0` 会永久等待（页面有持续网络请求），改用 `domcontentloaded`

### 阶段3: 采集内容错误 (走弯路)

| 时间 | 操作 | 结果 |
|------|------|------|
| +20分 | 用户指出采集内容是首页热门股票，不是搜索结果 | 确认问题 |
| +25分 | **错误决策**: 完全重写代码，改用直接访问URL | ❌ 0条 |
| +30分 | 用户批评：不应该丢弃成功的代码 | 写反省书 |

**严重错误**: 丢弃了已经成功加载首页和找到搜索框的代码，从零开始重写

### 阶段4: 分析搜索触发方式

| 时间 | 操作 | 结果 |
|------|------|------|
| +35分 | 恢复版本1代码 | 首页加载成功 |
| +40分 | 发现按回车后URL没变化 | form action为空 |
| +45分 | 分析DOM找到搜索按钮 | `div.submit._sptr` 有onclick |
| +50分 | 点击搜索按钮 | 新窗口打开！ |

**关键发现**: 搜索结果在新窗口打开，不是当前页面跳转

### 阶段5: 处理新窗口 (复杂化)

| 时间 | 操作 | 结果 |
|------|------|------|
| +55分 | 监听新窗口打开并切换 | 新窗口URL: `/bar/s` |
| +60分 | 分析新窗口DOM | 默认是"搜吧"tab |
| +65分 | 用户说需要点击"搜贴"和"按时间排序" | 用户提供3张截图 |
| +70分 | 点击搜贴和按时间排序 | 仍然0条 |

**问题**: 点击操作成功但内容没加载

### 阶段6: 用户建议直接访问URL

| 时间 | 操作 | 结果 |
|------|------|------|
| +75分 | 用户指出URL: `/tiezi/s?keyword=...#time` | 关键信息！ |
| +80分 | 直接访问该URL，用 `domcontentloaded` | ❌ 0条 |
| +85分 | 改用 `networkidle2` | ✅ 28条！ |
| +90分 | 最终修复完成 | 4只股票全部成功 |

**最终解决方案**: 
```javascript
const url = `https://so.eastmoney.com/tiezi/s?keyword=${encodeURIComponent(stockName)}#time`;
await page.goto(url, { waitUntil: 'networkidle2', timeout: 60000 });
```

---

## 3. 技术总结

### waitUntil 参数对比

| 参数 | 含义 | 适用场景 |
|------|------|----------|
| `networkidle0` | 500ms内无网络请求 | ❌ 不适合有持续请求的页面 |
| `networkidle2` | 500ms内不超过2个请求 | ✅ 动态页面推荐 |
| `domcontentloaded` | DOM加载完成 | 快速但可能内容没渲染 |
| `load` | 所有资源加载完成 | 静态页面 |

### 股吧搜索URL规律

| URL | 用途 |
|-----|------|
| `guba.eastmoney.com` | 首页 |
| `so.eastmoney.com/bar/s?keyword=...` | 搜吧（默认） |
| `so.eastmoney.com/tiezi/s?keyword=...#time` | 搜贴按时间排序 ✅ |

### 帖子选择器

```javascript
// 正确选择器：guba链接 + 非http开头的标题
if (href.includes('guba.eastmoney.com/news') && 
    text.length > 10 && 
    text.length < 200 &&
    !text.startsWith('http')) {
    return { title: text, url: href };
}
```

---

## 4. 错误反思

### 错误1: 过早放弃成功的代码

**表现**: 看到采集内容不对，就全盘否定，重写所有代码  
**正确做法**: 分析哪一步出了问题，在成功的基础上修复

### 错误2: 没有先分析DOM

**表现**: 盲目猜测选择器，多次试错  
**正确做法**: 先用分析脚本获取完整DOM信息

### 错误3: 没有仔细阅读用户提供的信息

**表现**: 用户早就提供了正确的URL截图，但我没有仔细分析  
**正确做法**: 用户截图是宝贵资源，要逐像素分析

---

## 5. 标准修复流程（总结）

```
1. 确认网络可达性
   curl -I https://目标网站

2. 测试不同waitUntil参数
   domcontentloaded → networkidle2 → networkidle0

3. 分析DOM结构
   创建 analyze-xxx.js 脚本

4. 从用户截图提取关键信息
   URL规律、选择器、操作流程

5. 在成功的基础上迭代
   不要丢弃已经成功的代码

6. 全量测试
   覆盖所有4只订阅股票

7. 记录经验
   更新TODO.md和本地文档
```

---

## 6. 最终代码

```javascript
/**
 * 东财股吧 搜索采集
 * 
 * 修复记录 (2025-12-31):
 * 1. 直接访问 so.eastmoney.com/tiezi/s?keyword=关键词#time
 * 2. 使用 networkidle2 等待页面完全加载
 * 3. 提取 guba.eastmoney.com 链接（帖子格式无【】开头）
 */
async function scrapeGubaForStock(stockCode, stockName, options = {}) {
    const { maxItems = 15 } = options;
    const results = [];
    const page = await puppeteer.createPage({
        timeout: 90000,
        blockResources: false
    });

    try {
        console.log(`[东财股吧] 搜索 ${stockCode} ${stockName}...`);

        // 直接访问搜索结果URL（按时间排序）
        const keyword = encodeURIComponent(stockName);
        const url = `https://so.eastmoney.com/tiezi/s?keyword=${keyword}#time`;
        console.log(`[东财股吧] URL: ${url}`);

        await page.goto(url, {
            waitUntil: 'networkidle2',
            timeout: 60000
        });

        console.log(`[东财股吧] 页面加载完成，等待渲染...`);
        await puppeteer.randomDelay(5000, 6000);

        // 提取guba链接
        const items = await page.$$eval('a', els =>
            els.map(el => {
                const text = el.textContent?.trim().replace(/\s+/g, ' ') || '';
                const href = el.href || '';

                if (href.includes('guba.eastmoney.com/news') && 
                    text.length > 10 && 
                    text.length < 200 &&
                    !text.startsWith('http')) {
                    return { title: text, url: href };
                }
                return null;
            }).filter(item => item)
        );

        // 去重并返回
        const seen = new Set();
        for (const item of items) {
            if (!seen.has(item.title) && results.length < maxItems) {
                seen.add(item.title);
                results.push({
                    title: item.title,
                    url: item.url,
                    source: 'guba',
                    sourceName: '东财股吧',
                    relatedStocks: [stockCode],
                    stockCode,
                    stockName
                });
            }
        }

        console.log(`[东财股吧] ${stockCode}: ${results.length} 条`);

    } catch (error) {
        console.error(`[东财股吧] ${stockCode} 失败:`, error.message);
    } finally {
        await puppeteer.closePage(page);
    }

    return results;
}
```

---

## 7. 测试结果

| 股票 | 采集数 | 样本内容 |
|------|--------|----------|
| 京东集团 (09618.HK) | 5条 | "大摩开始唱空京东要做空了..." |
| 小米集团 (01810.HK) | 5条 | "有黑子无端质疑精准确认感冒3号就会好..." |
| 中国联塑 (02128.HK) | 5条 | "中国联塑都敢和他合作说明不会退市..." |
| 禾赛 (02525.HK) | 5条 | "除了车，机器人业务增长飞快..." |

**总计**: 4只股票全部成功，**20条帖子** ✅

---

*文档创建时间: 2025-12-31 22:13*
