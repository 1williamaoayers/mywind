# MyWind 项目自动运转流程分析报告

**分析日期**: 2026-01-04  
**目的**: 理解项目部署后无人管理时的自动运转机制

---

## 📋 项目运转理论流程

当项目部署后没人管，**理论上**应该是这样运转的：

```
┌─────────────────────────────────────────────────────────────────┐
│                    MyWind 自动运转流程                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  docker-compose up -d                                           │
│         │                                                       │
│         ▼                                                       │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐        │
│  │   MongoDB   │    │  OCR服务    │    │  Node.js    │        │
│  │   容器      │    │   容器      │    │    服务     │        │
│  └─────────────┘    └─────────────┘    └──────┬──────┘        │
│                                              │                 │
│                                              ▼                 │
│                                   ┌──────────────────┐        │
│                                   │ schedulerService │        │
│                                   │   (node-cron)    │        │
│                                   └────────┬─────────┘        │
│                                            │                   │
│         ┌──────────────────────────────────┼───────────────┐  │
│         │                                  │               │  │
│         ▼                                  ▼               ▼  │
│  每5分钟采集           每30分钟深度采集      每2分钟预警推送  │
│  实时资讯              研报/公告            飞书通知        │
│         │                                  │               │  │
│         ▼                                  ▼               ▼  │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │                     MongoDB 存储                        │  │
│  │   news / announcements / alerts / reports               │  │
│  └─────────────────────────────────────────────────────────┘  │
│         │                                                      │
│         ▼                                                      │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │      飞书 Webhook → 用户手机收到推送                     │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## ⚠️ 关键发现：调度器未集成到服务器！

### 问题

我检查了 `server.js` (387行)：

```javascript
// server.js 没有引入 schedulerService！
// 搜索结果：0 条匹配
```

**结论**：`npm start` 或 `node server.js` 启动后，只有 **API服务** 在运行，**调度任务不会自动执行**！

### 证据

| 文件 | 是否引入调度器 |
|------|--------------|
| server.js | ❌ 没有 |
| schedulerService.js | ✅ 有 startScheduler 函数 |
| smartSchedulerService.js | ✅ 有 startScheduler 函数 |

---

## 📊 当前配置的定时任务 (schedulerService.js)

如果调度器正确启动，以下任务会自动运行：

| 任务 | 频率 | 说明 |
|------|------|------|
| 实时采集 | 每5分钟 | 采集实时资讯 |
| 深度采集 | 每30分钟 | 采集深度内容 |
| 预警推送 | 每2分钟 | 处理待推送预警 |
| 搜索引擎增强 | 每30分钟 | 搜索引擎采集 |
| 视觉采集 | 每天4次 | OCR识别今日头条 |
| 政策哨兵 | 每2小时 | 巡检政府官网 |
| 另类数据 | 每小时 | 汇率/美债/VIX |
| 腾讯财经 | 每2分钟 | 稳定兜底源 |
| 格隆汇 | 每10分钟 | 港美股快讯 |
| 研报生成 | 工作日15:30 | AI研报 |
| 数据清理 | 每天凌晨3点 | 清理30天前数据 |

---

## 🔧 修复方案

要让项目真正自动运转，需要在 `server.js` 中启动调度器：

```javascript
// server.js 需要添加：
const { startScheduler } = require('./services/schedulerService');

// 在 app.listen() 之后添加：
app.listen(PORT, () => {
    console.log('MyWind 服务启动...');
    
    // 启动调度器
    startScheduler();
    console.log('[调度器] 自动任务已启动');
});
```

---

## 📖 正确的运转流程应该是

1. **启动**: `docker-compose up -d` 或 `npm start`
2. **服务器**: Express 监听端口，提供 API
3. **调度器**: node-cron 定时触发采集任务
4. **采集**: 爬虫 → 过滤 → 入库 MongoDB
5. **预警**: 匹配规则 → 飞书推送
6. **报告**: 每日15:30 生成 AI 研报

---

## 💡 总结

| 问题 | 当前状态 |
|------|----------|
| server.js 是否启动调度器 | ❌ 没有 |
| 调度器代码是否存在 | ✅ 存在 |
| 项目能自动采集吗 | ❌ 不能 |

**要让项目"部署后没人管"也能自动运转，必须先修复 `server.js` 让调度器启动。**

---

## 📝 给用户的回答

**我理解您的意思了**：

您说的"项目真实运转"是指：
1. 启动项目后
2. 调度器自动按配置时间执行采集
3. 数据自动入库
4. 预警自动推送
5. 形成闭环，无需人工干预

但**当前项目有一个问题**：`server.js` 没有启动 `schedulerService`，所以即使运行 `npm start`，调度器也不会工作。

这是需要我修复的核心问题。
