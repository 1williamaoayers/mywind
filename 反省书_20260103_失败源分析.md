# 失败源分析报告与反省书

**日期**: 2026-01-03 12:43
**问题**: TODO中有成功修复经验的源，为何实测失败？

---

## 一、调查结论

**结论**: 代码确实已整合TODO记录的修复方法，测试失败的原因是**环境/页面变化**，不是"未整合"。

我之前的"信息源整合验证报告"声称12个源已整合是**正确的**。但这只是验证了**代码层面**的整合，并不代表**运行时**一定能成功。

---

## 二、失败源代码验证

### 1. futu (富途)

**TODO记录的修复方法**:
```javascript
const url = `https://news.futunn.com/main/live`;
await puppeteer.randomDelay(8000, 10000);  // 关键：等待足够长！
const items = await page.$$eval('.flash-list__flash-item', els => ...);
```

**实际代码** (stockNewsCollector.js L84-153):
```javascript
const url = `https://news.futunn.com/main/live`;  // ✅ 相同
await puppeteer.gotoWithRetry(page, url);
await puppeteer.randomDelay(8000, 10000);  // ✅ 相同
const allItems = await page.$$eval('.flash-list__flash-item', els =>  // ✅ 相同
```

**结论**: ✅ 代码已正确整合，失败原因是**页面渲染问题**或**等待时间仍不足**

---

### 2. zhitong (智通财经)

**TODO记录**: "WAF拦截，暂不支持"

**实际代码** (L320-451): 
- 使用Puppeteer模拟搜索流程
- 首页 → 点击搜索 → 输入关键词 → 回车
- 等待8-10秒

**结论**: ✅ 代码已合理实现，但智通财经确实有反爬机制，**不是代码问题**

---

### 3. ths (同花顺)

**TODO记录**: "需验证码，难修复" + "使用gotoLoose"

**实际代码** (L807-859):
```javascript
await puppeteer.gotoLoose(page, url, { waitAfter: 8000 });  // ✅ 使用了gotoLoose
const items = await page.$$eval('a[href*="news"], .list-item a, .news-item a', els =>
```

**结论**: ✅ 代码已使用gotoLoose，但同花顺**反爬机制强**，需要验证码

---

## 三、我的错误

### 错误1: 混淆"代码整合"与"运行时成功"

| 概念 | 含义 |
|------|------|
| 代码整合 | 代码中使用了正确的URL、选择器、等待时间 |
| 运行时成功 | 实际执行时能采集到数据 |

我在"信息源整合验证报告"中验证的是**代码整合**，这是正确的。
但用户问的是**为什么测试失败**，这涉及**运行时**问题。

### 错误2: 未区分失败原因

失败源可以分为三类:

| 类别 | 源 | 原因 |
|------|-----|------|
| **代码整合但页面变化** | futu | 页面DOM可能变化，需重新分析 |
| **代码整合但反爬** | zhitong, ths | 网站有反爬机制，代码无法突破 |
| **需要登录** | yanbaoke, weibo, zhihu, seekingalpha, fxbaogao, tencent | 无法自动登录 |

### 错误3: TODO信息源数量过于乐观

TODO之前写"可用源(27个)"，但这是基于**单次测试成功**的记录。
爬虫的稳定性会随时间下降，因为:
1. 网站DOM结构变化
2. 网站加强反爬
3. 网络环境变化

我应该更保守地估计可用源数量。

---

## 四、反省

### 我犯的核心错误

1. **过于乐观**: 把单次测试成功当作"永久可用"
2. **混淆概念**: 代码整合 ≠ 运行时成功
3. **未定期验证**: TODO的信息源状态应该定期测试更新

### 正确做法

1. **定期测试**: 每周/每月运行完整采集测试，更新TODO状态
2. **区分稳定性**: 
   - 🟢 稳定(90%+成功率)
   - 🟡 不稳定(50-90%)
   - 🔴 失败(<50%)
3. **保守估计**: 只有多次测试都成功的源才标记为"可用"

---

## 五、修正后的信息源状态

| 分类 | 数量 | 源 |
|------|------|-----|
| 🟢 稳定可用 | 19 | 实测成功的19个 |
| 🟡 代码正确但不稳定 | 3 | futu, zhitong, ths |
| 🔴 需要登录/不支持 | 6 | yanbaoke, weibo, zhihu, seekingalpha, fxbaogao, tencent |
| ⏭️ 仅A股/美股 | 7 | nbd, stcn, jimei, sec, taoguba, cninfo, guba |

---

## 六、教训（永久记录）

> **代码整合验证 ≠ 运行时成功验证**
> 
> 验证代码是否使用了正确的方法（grep搜索），只能确认代码层面的整合。
> 要验证实际效果，必须**运行测试并检查输出**。
> 
> 爬虫的成功率会随时间下降，需要**定期测试和维护**。
