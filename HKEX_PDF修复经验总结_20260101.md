# 披露易 (HKEX) PDF内容提取修复经验总结

**日期**: 2026-01-01
**项目**: MyWind 智能投研
**模块**: 数据采集 (StockNewsCollector) / PDF解析

## 1. 问题背景

我们需要从 HKEX 披露易网站抓取上市公司公告。虽然大多数公告是 HTML 格式，但许多重要文件（如财报、翌日披露报表、招股书）是 PDF 格式。

**最初遇到的问题**:
1. **内容不全**: 使用 Puppeteer 截图 + OCR 时，多页 PDF 只能提取到第一页的内容，重复多次。
2. **OCR 质量差**: 对于表格密集型文档（如股份购回 FF305 表格），OCR 置信度极低（22%-30%），基本无法读取。
3. **技术限制**: 无法直接通过 JS 控制 Chrome PDF Viewer 进行翻页。

## 2. 根本原因分析

经过深入排查，发现根本原因在于 Chrome 浏览器内嵌的 PDF 查看器机制：

*   **Embed 插件机制**: Chrome 使用 `<embed type="application/pdf">` 标签来渲染 PDF。这是一个浏览器的原生插件，其内部滚动条独立于网页 DOM。
*   **JS 失效**: 标准的 JavaScript 滚动命令（如 `window.scrollBy` 或 `window.scrollTo`）作用于页面的 `<body>`，但对 `<embed>` 插件内部的 PDF 渲染区域无效。
*   **截图限制**: Puppeteer 的 `page.screenshot()` 只能捕获当前视口。因为无法滚动，每次截图都截取了初始视口（即第一页），导致所有页面的截图完全相同。

## 3. 探索过的方案 (避坑指南)

在找到最终方案前，我们尝试了以下方法，均存在问题：

| 方案 | 结果 | 原因分析 |
| :--- | :--- | :--- |
| **方案 1: Puppeteer 滚动截图** | ❌ 失败 | Chrome PDF Viewer 插件无法被 JS 滚动，导致只截取第一页。 |
| **方案 2: pdf.js (浏览器版)** | ❌ 失败 | 尝试在 Puppeteer 中注入 pdf.js 渲染 PDF 到 Canvas。实现复杂，且受限于跨域资源策略 (CORS)。 |
| **方案 3: pdfjs-dist (Node库)** | ❌ 失败 | 项目依赖的 `pdfjs-dist` (v1.x) 版本过老，API 不兼容现代写法。且该库强依赖 DOM 环境 (`document is not defined` 错误)，在纯 Node.js 环境下需要模拟 DOM，极其麻烦。 |

## 4. 最终解决方案 (成功)

**方案核心**: 放弃浏览器渲染，使用系统级工具直接处理 PDF 文件。

**技术栈**:
*   **下载**: 使用 Node.js `https` 模块直接下载 PDF 二进制流。
*   **转换**: 使用 **`poppler-utils`** 工具包中的 **`pdftoppm`** 命令行工具。
*   **OCR**: 使用 `tesseract.js` 对生成的图片进行文字识别。

**实施步骤**:

1.  **系统依赖安装**:
    ```bash
    apt-get install poppler-utils  # 必须安装
    ```

2.  **工具封装 (`pdfRenderer.js`)**:
    *   编写 `downloadPdfToFile`: 将 URL 下载为本地临时文件。
    *   编写 `pdfToImages`: 调用 `pdftoppm -png -r 200 -l 10 input.pdf output_prefix`。
        *   `-png`: 输出 PNG 格式。
        *   `-r 200`: 设置 DPI 为 200（保证 OCR 识别率又不过大）。
        *   `-l 10`: 限制最多处理 10 页（防止超大文件卡死）。

3.  **OCR 处理**:
    *   遍历生成的 PNG 文件列表。
    *   对每张图片调用 `Tesseract.recognize` (chi_sim+eng)。
    *   合并所有页面的文本结果。

## 5. 修复成果验证

以小米集团 (01810.HK) 的《翌日披露报表》(FF305) 为例：

| 指标 | 修复前 (Puppeteer截图) | 修复后 (Poppler转换) |
| :--- | :--- | :--- |
| **提取页数** | 8页 (但全是第1页重复) | **8页 (完整真实页码)** |
| **OCR 置信度** | 22% - 30% | **~81%** |
| **内容完整性** | 仅含表头，数据丢失 | **完整包含表格数据、日期、金额** |
| **文件大小** | 截图 347KB | 转换图片清晰度可控 |

## 6. 经验教训 (Lessons Learned)

1.  **不要相信 PDF 截图**: 在无头浏览器中对 PDF 查看器进行截图是非常不可靠的，插件行为难以控制。
2.  **专业工具做专业事**: `pdf-parse` 适合提纯文本 PDF，`poppler` 适合渲染复杂/扫描版 PDF。不要试图用一种工具解决所有问题。
3.  **环境依赖检查**: `pdfjs-dist` 等库对 Node 版本和 DOM 环境有严格要求，使用前务必检查依赖树和版本兼容性。
4.  **先记录再执行**: 按照新规则 "先记录 TODO 再执行"，有效避免了盲目尝试，让排查过程更有条理。

---
*Generated by Antigravity Agent*
